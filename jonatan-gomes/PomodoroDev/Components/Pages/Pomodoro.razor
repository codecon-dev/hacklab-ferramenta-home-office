@page "/pomodoroDev"
@rendermode InteractiveServer

@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>Pomodoro</PageTitle>

<div class="pomodoro-container">
    <h1>🍅 Pomodoro 🍅</h1>

    <div class="timer-display">
        <span>@tempoMin.ToString("D2")</span>:<span>@tempoSeg.ToString("D2")</span>
    </div>

    <div class="status-info">
        <p><strong>Ciclo atual:</strong> @ciclo</p>
        <p><strong>Modo atual:</strong> @modo</p>
    </div>

    <div class="button-group">
        <button class="@($"btn {(rodando ? "pause" : "start")}")" @onclick="ToggleRunning">
            @(rodando ? "Pausar" : "Iniciar")
        </button>
        <button class="btn reset" @onclick="Resetar">Resetar</button>
    </div>

    <audio id="alertSound" src="alertSound.wav" style="display:none"></audio>

    <div class="youtube-player" aria-hidden="false">
        <iframe id="youtubePlayer" width="560" height="315"
                src="https://www.youtube.com/embed/TK4knqwHPQ8?enablejsapi=1&autoplay=0&loop=1&playlist=TK4knqwHPQ8"
                title="YouTube Pomodoro Playlist"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
        </iframe>
    </div>
</div>

@if (showPauseModal)
{
    <div class="pause-modal-backdrop" @onclick="ClosePauseModal">
        <div class="pause-modal" @onclick:stopPropagation>
            <h3>@pauseModalTitle</h3>
            <p>@pauseModalMessage</p>
            <div class="modal-actions">
                <button class="btn primary" @onclick="ClosePauseModal">Ok, entendi</button>
            </div>
        </div>
    </div>
}

<style>
    .pomodoro-container {
        max-width: 550px;
        margin: 40px auto;
        text-align: center;
        font-family: 'Segoe UI', sans-serif;
        background-color: #f9f9f9;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    .timer-display {
        font-size: 80px;
        font-weight: bold;
        color: #333;
        margin: 20px 0;
    }

    .status-info p {
        font-size: 18px;
        margin: 5px 0;
    }

    .button-group {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
    }

    .btn {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

        .btn.start {
            background-color: #4CAF50;
            color: white;
        }

        .btn.pause {
            background-color: #FFC107;
            color: white;
        }

        .btn.reset {
            background-color: #f44336;
            color: white;
        }

        .btn.primary {
            background: linear-gradient(90deg, rgba(155,108,255,0.95), rgba(0,200,255,0.9));
            color: #fff;
        }

        .btn:hover {
            opacity: 0.9;
        }

    .youtube-player {
        position: fixed;
        top: 16px;
        right: 16px;
        width: 240px;
        height: 135px;
        z-index: 9999;
        box-shadow: 0 6px 18px rgba(0,0,0,0.15);
        border-radius: 8px;
        overflow: hidden;
        background: #000;
    }

    .youtube-player iframe {
        width: 100%;
        height: 100%;
        border: 0;
        display: block;
    }

    @@media (max-width: 600px) {
        .youtube-player {
            display: none;
        }
    }

    /* Pause modal styles */
    .pause-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20000;
        padding: 1rem;
    }

    .pause-modal {
        max-width: 520px;
        width: 100%;
        background: linear-gradient(180deg, #ffffff, #fbfbfb);
        color: #222;
        padding: 1.6rem 1.8rem;
        border-radius: 12px;
        box-shadow: 0 18px 50px rgba(0,0,0,0.6);
        text-align: left;
    }

    .pause-modal h3 {
        margin: 0 0 0.6rem;
    }

    .pause-modal p {
        margin: 0 0 1rem;
        color: #333;
    }

    .pause-modal .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .pause-modal .btn { padding: 8px 14px; border-radius: 8px; }
    .pause-modal .btn[onclick] { cursor: pointer; }
</style>

@code {
    private string modo = "Foco";
    private int tempoMin = 0;
    private int tempoSeg = 10;
    private bool rodando = false;
    private int ciclo = 1;

    private IJSObjectReference? pomodoroModule;

    // modal de pausa
    private bool showPauseModal = false;
    private string pauseModalTitle = "Pausa ;)";
    private string pauseModalMessage = "";

    private readonly string[] pauseReminders = new[]
    {
        "Tá feio o negócio, não da pra esperar a pausa longa pra dar aquela cagada remunerada? Corre que tu só tem 5 minutos!",
        "Ninguém é de ferro! Vai dar uma volta, tomar um café, fumar um derby (Ministério da saúde adverte...)",
        "Boa! Hoje tu tá com o molho!",
        "Pensamentos de um dev..: Qual será o próximo passo do grande RollBack? - Mais uma reunião que podia ter sido um e-mail... - Será que eu tanko sair na mão com um urso? - Preciso de mais café...",
        "Não esquece de bloquear a tela animal! Olha o NCage!",
        "Como diria o Lucas Montano do canal Lucas Montano: 'Hidrate-se!!'"
    };

    private async Task EnsureModule()
    {
        if (pomodoroModule == null)
        {
            pomodoroModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/pomodoro.js");
        }
    }

    // Botão único: inicia/pausa o timer e controla o YouTube
    private async Task ToggleRunning()
    {
        if (rodando)
        {
            // Pausar: interrompe o loop e pausa o player
            rodando = false;
            try
            {
                await EnsureModule();
                await pomodoroModule!.InvokeVoidAsync("pauseYouTube", "youtubePlayer");
            }
            catch
            {
            }

            // mostrar modal de pausa ao pausar manualmente (permanece aberto até Ok ou fim da pausa)
            _ = ShowPauseReminderAsync();

            StateHasChanged();
            return;
        }

        // Iniciar (ao iniciar, fechamos qualquer modal de pausa)
        ClosePauseModal();

        await EnsureModule();

        try
        {
            await pomodoroModule!.InvokeVoidAsync("unlockAudio", "alertSound.wav");
        }
        catch
        {
        }

        rodando = true;

        // tocar ou pausar youtube conforme modo atual
        try
        {
            if (modo == "Foco")
            {
                await pomodoroModule!.InvokeVoidAsync("playYouTube", "youtubePlayer");
            }
            else
            {
                await pomodoroModule!.InvokeVoidAsync("pauseYouTube", "youtubePlayer");
            }
        }
        catch
        {
        }

        StateHasChanged();

        // Loop principal do timer (executa enquanto rodando)
        while (rodando)
        {
            while (rodando && (tempoMin > 0 || tempoSeg > 0))
            {
                await Task.Delay(1000);
                DecrementarTempo();
                StateHasChanged();
            }

            if (!rodando) break;

            if (tempoMin == 0 && tempoSeg == 0)
            {
                try
                {
                    await EnsureModule();
                    await pomodoroModule!.InvokeVoidAsync("playAlert");
                }
                catch
                {
                }

                await AlternarModoAsync();
                StateHasChanged();
            }
        }
    }

    private async Task Resetar()
    {
        rodando = false;
        ciclo = 1;
        modo = "Foco";
        tempoMin = 25;
        tempoSeg = 0;

        // fechar modal caso esteja aberto
        ClosePauseModal();

        try
        {
            await EnsureModule();
            await pomodoroModule!.InvokeVoidAsync("pauseYouTube", "youtubePlayer");
        }
        catch
        {
        }
    }

    private async Task AlternarModoAsync()
    {
        if (modo == "Foco")
        {
            if (ciclo < 4)
            {
                modo = "Pausa";
                tempoMin = 5;
                tempoSeg = 0;

                try { await EnsureModule(); await pomodoroModule!.InvokeVoidAsync("pauseYouTube", "youtubePlayer"); } catch { }

                // mostrar lembrete ao entrar em pausa automática (permanece até Ok ou fim da pausa)
                _ = ShowPauseReminderAsync();
            }
            else
            {
                modo = "Pausa Longa";
                tempoMin = 15;
                tempoSeg = 0;

                try { await EnsureModule(); await pomodoroModule!.InvokeVoidAsync("pauseYouTube", "youtubePlayer"); } catch { }

                _ = ShowPauseReminderAsync();
            }
        }
        else
        {
            if (modo == "Pausa Longa")
            {
                rodando = false;

                ciclo = 1;
                modo = "Foco";
                tempoMin = 25;
                tempoSeg = 0;

                // ao voltar para Foco, garantir que o modal seja fechado
                ClosePauseModal();

                try { await EnsureModule(); await pomodoroModule!.InvokeVoidAsync("pauseYouTube", "youtubePlayer"); } catch { }
            }
            else
            {
                ciclo++;
                modo = "Foco";
                tempoMin = 25;
                tempoSeg = 0;

                // fechar modal ao voltar para foco
                ClosePauseModal();

                try { await EnsureModule(); if (rodando) await pomodoroModule!.InvokeVoidAsync("playYouTube", "youtubePlayer"); } catch { }
            }
        }
    }

    // mostra o modal de pausa e deixa aberto até o usuário fechar ou até a pausa terminar
    private Task ShowPauseReminderAsync()
    {
        var rnd = new Random();
        pauseModalTitle = modo == "Pausa Longa" ? "Pausa Longa" : "Pausa";
        pauseModalMessage = pauseReminders[rnd.Next(pauseReminders.Length)];

        showPauseModal = true;
        InvokeAsync(StateHasChanged);

        return Task.CompletedTask;
    }

    private void ClosePauseModal()
    {
        showPauseModal = false;
        InvokeAsync(StateHasChanged);
    }

    private void DecrementarTempo()
    {
        if (tempoSeg == 0)
        {
            if (tempoMin > 0)
            {
                tempoMin--;
                tempoSeg = 59;
            }
        }
        else
        {
            tempoSeg--;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (pomodoroModule != null)
        {
            await pomodoroModule.DisposeAsync();
        }
    }
}